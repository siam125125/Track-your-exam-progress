<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIAM Exam Summary Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Using Inter font */
        :root {
            --font-inter: 'Inter', sans-serif;
        }
        body {
            font-family: var(--font-inter);
        }
        /* CSS Transitions */
        .transition-colors {
            transition: background-color 0.3s, color 0.3s;
        }
        /* Sticky element positioning */
        .sticky-top-24 {
            top: 6rem;
        }
        /* Hide default number input arrows */
        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        /* Style for selected history card */
        .selected-exam-card {
            border-color: var(--color-indigo-500) !important;
            box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.1), 0 2px 4px -2px rgba(99, 102, 241, 0.1);
        }
        .dark .selected-exam-card {
            border-color: var(--color-indigo-400) !important;
        }
        .ranking-name {
            cursor: pointer;
            text-decoration: underline;
            text-decoration-color: currentColor;
            text-underline-offset: 2px;
            transition: opacity 0.2s;
        }
        .ranking-name:hover {
            opacity: 0.8;
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'indigo-500': '#6366f1',
                        'indigo-400': '#818cf8',
                    }
                }
            }
        }
    </script>
</head>
<body class="transition-colors duration-300">

    <div id="app" class="min-h-screen bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 transition-colors duration-300">
        
        <header class="bg-indigo-600 dark:bg-indigo-900 text-white shadow-lg sticky top-0 z-50 transition-colors duration-300">
            <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex items-center gap-3 w-full md:w-auto">
                    <div class="bg-white dark:bg-slate-800 p-2 rounded-full text-indigo-600 dark:text-indigo-400">
                        <i data-lucide="trophy" class="w-6 h-6"></i>
                    </div>
                    <div class="flex-1">
                        <div id="app-title-container" class="flex items-center gap-2 group cursor-pointer">
                            <h1 id="app-title-display" class="text-xl md:text-2xl font-bold tracking-wide">SIAM Exam Summary Tracker</h1>
                            <i data-lucide="edit-2" class="w-3.5 h-3.5 opacity-0 group-hover:opacity-50 transition-opacity"></i>
                        </div>
                        <p id="user-info" class="text-xs text-indigo-200 dark:text-indigo-300 flex items-center gap-1">
                            <i data-lucide="user" class="w-3 h-3"></i>
                            User ID: Loading...
                        </p>
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <div class="text-right hidden sm:block">
                        <p id="current-date" class="text-sm font-medium opacity-90"></p>
                    </div>
                    <button id="dark-mode-toggle" class="p-2 bg-indigo-500 dark:bg-indigo-800 rounded-full hover:bg-indigo-400 transition-colors" title="Toggle Dark Mode">
                        <i data-lucide="moon" id="dark-mode-icon" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-4 py-8">
            
            <div id="loading-indicator" class="text-center py-12 text-indigo-600 dark:text-indigo-400 hidden">
                <i data-lucide="loader-circle" class="w-8 h-8 mx-auto animate-spin"></i>
                <p class="mt-2 font-medium">Synced Cloud Data Loading...</p>
            </div>

            <section id="summary-cards" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                </section>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                
                <div class="lg:col-span-4">
                    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md overflow-hidden border border-slate-100 dark:border-slate-700 sticky sticky-top-24 transition-colors">
                        <div class="bg-slate-800 dark:bg-slate-900 p-4 text-white flex items-center gap-2">
                            <i data-lucide="calculator" class="w-4.5 h-4.5"></i>
                            <h2 class="font-semibold">Calculate & Add Exam</h2>
                        </div>
                        
                        <form id="exam-form" class="p-5 space-y-4">
                            
                            <div class="space-y-1">
                                <label class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase">Your Name (For Ranking)</label>
                                <input type="text" name="userName" required placeholder="Enter your name" id="form-userName"
                                    class="w-full p-2 border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm transition-colors"
                                />
                                <div class="mt-2">
                                    <button type="button" id="google-sign-in-button" 
                                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg shadow transition duration-200 flex items-center justify-center gap-2 text-sm">
                                        <i data-lucide="log-in" class="w-4 h-4"></i>
                                        Sign in with Google
                                    </button>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <div class="space-y-1">
                                    <label class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase">Date</label>
                                    <input type="date" name="date" required id="form-date"
                                        class="w-full p-2 border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm transition-colors"
                                    />
                                </div>
                                <div class="space-y-1">
                                    <label class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase">Standard (Batch/Class)</label>
                                    <input type="text" name="standard" placeholder="Class / Batch" id="form-standard"
                                        class="w-full p-2 border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm transition-colors"
                                    />
                                </div>
                            </div>

                            <div class="space-y-1">
                                <label class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase">Exam Name</label>
                                <input type="text" name="examName" required placeholder="Example: Biology Final" id="form-examName"
                                    class="w-full p-2 border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm transition-colors"
                                />
                            </div>

                            <div class="space-y-1">
                                <label class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase">Optional/Attempted Subjects</label>
                                <input type="text" name="optionalSubject" placeholder="E.g.: Physics, Chemistry (Separate by comma)" id="form-optionalSubject"
                                    class="w-full p-2 border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm transition-colors"
                                />
                            </div>

                            <div class="p-3 bg-indigo-50 dark:bg-indigo-900/30 rounded-lg border border-indigo-100 dark:border-indigo-800 space-y-3">
                                <div class="flex items-center gap-2 text-indigo-800 dark:text-indigo-300 mb-1">
                                    <i data-lucide="alert-triangle" class="w-3.5 h-3.5"></i>
                                    <h3 class="text-xs font-bold uppercase tracking-wider">Exam Settings (Marking)</h3>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="space-y-1">
                                        <label class="text-xs text-slate-600 dark:text-slate-400">Total Questions</label>
                                        <input type="number" name="totalQuestions" required placeholder="50" id="form-totalQuestions" value="50"
                                            class="w-full p-2 border border-indigo-200 dark:border-indigo-700 dark:bg-slate-800 dark:text-white rounded text-sm focus:border-indigo-500 outline-none"
                                        />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs text-slate-600 dark:text-slate-400">Mark per Q.</label>
                                        <input type="number" name="markPerQuestion" step="0.1" id="form-markPerQuestion" value="1"
                                            class="w-full p-2 border border-indigo-200 dark:border-indigo-700 dark:bg-slate-800 dark:text-white rounded text-sm focus:border-indigo-500 outline-none"
                                        />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs text-slate-600 dark:text-slate-400">Negative Mark</label>
                                        <input type="number" name="negativePerWrong" step="0.01" id="form-negativePerWrong" value="0.25"
                                            class="w-full p-2 border border-indigo-200 dark:border-indigo-700 dark:bg-slate-800 dark:text-white rounded text-sm focus:border-indigo-500 outline-none"
                                        />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs text-slate-600 dark:text-slate-400">GPA/Added Mark</label>
                                        <input type="number" name="gpaMark" step="0.1" id="form-gpaMark" value="0"
                                            class="w-full p-2 border border-indigo-200 dark:border-indigo-700 dark:bg-slate-800 dark:text-white rounded text-sm focus:border-indigo-500 outline-none"
                                        />
                                    </div>
                                </div>
                            </div>

                            <div class="p-3 bg-slate-50 dark:bg-slate-700/50 rounded-lg border border-slate-200 dark:border-slate-600 space-y-3">
                                <h3 class="text-xs font-bold text-slate-600 dark:text-slate-300 uppercase tracking-wider mb-2">My Performance</h3>
                                <div class="grid grid-cols-3 gap-2">
                                    <div class="space-y-1 text-center">
                                        <label class="text-xs text-green-600 dark:text-green-400 font-medium">Correct (Use + for sum)</label>
                                        <input type="text" name="correctAns" placeholder="0" id="form-correctAns" value="0"
                                            class="w-full p-2 text-center border border-green-200 dark:border-green-800 dark:bg-slate-800 dark:text-white rounded text-sm focus:ring-1 focus:ring-green-500 outline-none"
                                        />
                                    </div>
                                    <div class="space-y-1 text-center">
                                        <label class="text-xs text-red-600 dark:text-red-400 font-medium">Wrong (Use + for sum)</label>
                                        <input type="text" name="wrongAns" placeholder="0" id="form-wrongAns" value="0"
                                            class="w-full p-2 text-center border border-red-200 dark:border-red-800 dark:bg-slate-800 dark:text-white rounded text-sm focus:ring-1 focus:ring-red-500 outline-none"
                                        />
                                    </div>
                                    <div class="space-y-1 text-center">
                                        <label class="text-xs text-gray-600 dark:text-gray-400 font-medium">Skipped</label>
                                        <input type="number" name="skippedAns" placeholder="Auto" readonly id="form-skippedAns" value="0"
                                            class="w-full p-2 text-center border border-gray-200 dark:border-gray-600 bg-gray-100 dark:bg-slate-600 dark:text-gray-300 rounded text-sm outline-none cursor-not-allowed"
                                        />
                                    </div>
                                </div>
                            </div>

                            <button type="submit" id="save-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-lg shadow transition duration-200 flex items-center justify-center gap-2">
                                <i data-lucide="save" class="w-4.5 h-4.5"></i>
                                Save to Cloud & View Results
                            </button>
                        </form>
                    </div>
                </div>

                <div class="lg:col-span-8 space-y-6">
                    
                    <div id="ranking-details-container" class="hidden">
                        </div>

                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 mb-2">
                        <h2 class="text-xl font-bold text-slate-800 dark:text-slate-100 flex items-center gap-2">
                            <i data-lucide="calendar" class="w-5 h-5 text-indigo-600 dark:text-indigo-400"></i>
                            <span id="history-title">My Exam History</span>
                        </h2>
                        <div class="flex items-center gap-2">
                            <button id="view-toggle" class="text-sm bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300 px-3 py-1 rounded-lg font-medium transition-colors">
                                View All Public Records
                            </button>
                            <span id="record-count" class="text-sm bg-indigo-100 dark:bg-indigo-900/50 text-indigo-700 dark:text-indigo-300 px-3 py-1 rounded-full font-medium">
                                0 Records
                            </span>
                        </div>
                    </div>

                    <div id="history-container">
                        <div id="no-data-message" class="hidden bg-white dark:bg-slate-800 rounded-xl shadow-sm p-12 text-center border border-dashed border-slate-300 dark:border-slate-600">
                            <div class="inline-flex items-center justify-center w-16 h-16 bg-slate-100 dark:bg-slate-700 rounded-full mb-4 text-slate-400">
                                <i data-lucide="book-open" class="w-8 h-8"></i>
                            </div>
                            <h3 class="text-lg font-medium text-slate-700 dark:text-slate-300">No Exam Records Found</h3>
                            <p class="text-slate-500 dark:text-slate-400 mt-2">Use the calculator on the left to add your first exam.</p>
                        </div>
                    </div>
                </div>

            </div>
        </main>
        
        <div id="stats-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] hidden" onclick="document.getElementById('stats-modal').classList.add('hidden')">
            <div id="modal-content" class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-lg mx-4 p-6 transition-all transform scale-100" onclick="event.stopPropagation()">
                <div class="flex items-center justify-between border-b pb-3 mb-4 border-slate-200 dark:border-slate-700">
                    <h3 class="text-xl font-bold text-slate-800 dark:text-slate-100 flex items-center gap-2">
                        <i data-lucide="user-check" class="w-5 h-5 text-indigo-500"></i>
                        Competitor's Overall Summary
                    </h3>
                    <button class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200" onclick="document.getElementById('stats-modal').classList.add('hidden')">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div id="stats-data-container">
                    </div>
            </div>
        </div>
        
    </div>
<script>
    // This variable is where your core code looks for the configuration. 
    // The configuration is placed within backticks (`) as a JSON string
    // to avoid potential linting errors.
    const __firebase_config = `{
      "apiKey": "AIzaSyCS4aujQoztekg4Wi5q9wgQXOtqld8_cdc",
      "authDomain": "exam-tracker-app-4978d.firebaseapp.com",
      "projectId": "exam-tracker-app-4978d",
      "storageBucket": "exam-tracker-app-4978d.firebasestorage.app",
      "messagingSenderId": "267648123000",
      "appId": "1:267648123000:web:21261ec51849dba2be6d8d",
      "measurementId": "G-VZF8XRT6YT"
    }`;
    
    // Your App ID:
    const __app_id = 'default-siam-tracker'; 
</script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // **UPDATED IMPORT**: Added GoogleAuthProvider and signInWithPopup
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, onSnapshot, collection, deleteDoc, query, orderBy, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // setLogLevel('debug'); // Uncomment to see Firebase logs

        // --- GLOBAL FIREBASE/APP VARS ---
        let db = null;
        let auth = null;
        let userId = null;
        let userName = "Anonymous User"; 
        let isAuthReady = false;
        let exams = []; // Local mirror of cloud data (now contains ALL public exams)
        let activeExamName = null; // Stores the exam name currently being ranked
        let isShowingAllExams = false; // NEW STATE: For toggling history view
        
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-siam-tracker';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Constants for localStorage (Theme/Title/Name)
        const APP_TITLE_KEY = 'siam_app_title';
        const THEME_KEY = 'siam_theme';
        const USER_NAME_KEY = 'siam_user_name';
        let darkMode = false;

        // --- DOM Elements ---
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const darkModeIcon = document.getElementById('dark-mode-icon');
        const currentDateDisplay = document.getElementById('current-date');
        const appTitleContainer = document.getElementById('app-title-container');
        const appTitleDisplay = document.getElementById('app-title-display');
        const summaryCardsContainer = document.getElementById('summary-cards');
        const historyContainer = document.getElementById('history-container');
        const recordCountElement = document.getElementById('record-count');
        const noDataMessage = document.getElementById('no-data-message');
        const examForm = document.getElementById('exam-form');
        const userInfoDisplay = document.getElementById('user-info');
        const loadingIndicator = document.getElementById('loading-indicator');
        const saveButton = document.getElementById('save-button');
        const rankingDetailsContainer = document.getElementById('ranking-details-container');
        const statsModal = document.getElementById('stats-modal');
        const statsDataContainer = document.getElementById('stats-data-container');
        const googleSignInButton = document.getElementById('google-sign-in-button'); 

        // NEW DOM Elements for History Toggle
        const historyTitle = document.getElementById('history-title');
        const viewToggle = document.getElementById('view-toggle');

        const formTotalQuestions = document.getElementById('form-totalQuestions');
        const formCorrectAns = document.getElementById('form-correctAns');
        const formWrongAns = document.getElementById('form-wrongAns');
        const formSkippedAns = document.getElementById('form-skippedAns');
        const formUserName = document.getElementById('form-userName');

        // --- Utility Functions ---

        // Function to safely calculate sums like "10+5+2"
        const parseInputSum = (value) => {
            const trimmedValue = value.toString().trim();
            if (!trimmedValue) return 0;

            const parts = trimmedValue.split('+').map(p => {
                const num = parseInt(p.trim());
                return isNaN(num) ? 0 : num;
            });
            
            return parts.reduce((sum, num) => sum + num, 0);
        };

        const calculateGrade = (percentage) => {
            if (percentage >= 80) return { point: "5.00", grade: "A+" };
            if (percentage >= 70) return { point: "4.00", grade: "A" };
            if (percentage >= 60) return { point: "3.50", grade: "A-" };
            if (percentage >= 50) return { point: "3.00", grade: "B" };
            if (percentage >= 40) return { point: "2.00", grade: "C" };
            if (percentage >= 33) return { point: "1.00", grade: "D" };
            return { point: "0.00", grade: "F" };
        };

        const calculateAccuracy = (correct, wrong) => {
            const attempted = parseInt(correct || 0) + parseInt(wrong || 0);
            if (attempted === 0) return 0;
            return ((parseInt(correct || 0) / attempted) * 100).toFixed(1);
        };

        // --- Firestore Functions ---
        const getExamCollectionRef = () => {
            if (!db) {
                console.error("Firestore not initialized.");
                return null;
            }
            // Using Public collection for multi-user sharing/ranking
            const path = `/artifacts/${APP_ID}/public/data/exams`;
            return collection(db, path);
        };

        const saveExamToFirestore = async (examData) => {
            const examsRef = getExamCollectionRef();
            if (!examsRef) return;

            // Update local storage name whenever we save an exam
            localStorage.setItem(USER_NAME_KEY, examForm.userName.value.trim() || `User-${userId.substring(0, 6)}`);
            userName = localStorage.getItem(USER_NAME_KEY);
            formUserName.value = userName; // Keep form updated
            
            const docId = examData.id ? examData.id.toString() : Date.now().toString();

            try {
                const { id, ...dataToSave } = examData; 
                
                const dataWithUser = { 
                    ...dataToSave, 
                    id: docId, 
                    timestamp: Date.now(),
                    userId: userId,
                    userName: userName // Use the user-provided name
                };

                await setDoc(doc(examsRef, docId), dataWithUser);
                console.log("Exam saved/updated successfully, ID:", docId);
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        };

        const deleteExamFromFirestore = async (docId) => {
            const examsRef = getExamCollectionRef();
            if (!examsRef) return;

            try {
                await deleteDoc(doc(examsRef, docId));
                console.log("Document successfully deleted!");
            } catch (e) {
                console.error("Error removing document: ", e);
            }
        };

        const startRealtimeListener = () => {
            if (!isAuthReady || !userId) {
                console.log("Waiting for authentication before setting up Firestore listener.");
                return;
            }

            const examsRef = getExamCollectionRef();
            if (!examsRef) return;
            
            loadingIndicator.classList.remove('hidden'); 

            const q = query(examsRef);

            onSnapshot(q, (snapshot) => {
                loadingIndicator.classList.add('hidden');
                
                let fetchedExams = [];
                snapshot.forEach((doc) => {
                    fetchedExams.push({ id: doc.id, ...doc.data() });
                });

                // Store all exams. Sorting is done in renderHistory/renderRankingDetails
                exams = fetchedExams; 
                
                renderHistory();
                
                // If no active exam set, try to set the latest one from the *user's* records
                if (!activeExamName && exams.length > 0) {
                    activeExamName = exams.filter(e => e.userId === userId).sort((a, b) => b.timestamp - a.timestamp)[0]?.examName || exams[0].examName;
                }
                
                if (activeExamName) {
                    renderRankingDetails(activeExamName);
                } else {
                    rankingDetailsContainer.classList.add('hidden');
                }
            }, (error) => {
                loadingIndicator.classList.add('hidden'); 
                console.error("Firestore snapshot error:", error);
            });
        };

        // --- Ranking Functions ---

        const calculateOverallStatsForUser = (targetUserId) => {
            const userExams = exams.filter(e => e.userId === targetUserId);

            const totalExams = userExams.length;
            
            const totalMCQScore = userExams.reduce((acc, curr) => acc + parseFloat(curr.calculatedData?.mcqScore || 0), 0);
            const totalMCQPossible = userExams.reduce((acc, curr) => acc + (parseInt(curr.totalQuestions || 0) * parseFloat(curr.markPerQuestion || 1)), 0);
            
            const totalCorrect = userExams.reduce((acc, curr) => acc + parseInt(curr.correctAns || 0), 0);
            const totalWrong = userExams.reduce((acc, curr) => acc + parseInt(curr.wrongAns || 0), 0);
            
            const totalAttempted = totalCorrect + totalWrong;
            const overallAccuracy = calculateAccuracy(totalCorrect, totalWrong);

            // Get the user's latest name from the exams data
            const latestExam = userExams.sort((a, b) => b.timestamp - a.timestamp)[0];
            const name = latestExam?.userName || "Unknown User";

            return {
                name,
                totalExams,
                totalMCQScore: totalMCQScore.toFixed(2),
                totalMCQPossible: totalMCQPossible.toFixed(2),
                totalCorrect,
                totalWrong,
                overallAccuracy
            };
        };

        const showUserStatsModal = (targetUserId) => {
            const stats = calculateOverallStatsForUser(targetUserId);

            const statHtml = `
                <h4 class="text-2xl font-extrabold text-indigo-600 dark:text-indigo-400 mb-4">${stats.name}'s Summary</h4>
                <div class="space-y-3">
                    <div class="flex items-center justify-between border-b pb-2">
                        <span class="text-sm font-medium text-slate-500 dark:text-slate-400">Total Exams Recorded</span>
                        <span class="text-lg font-bold text-slate-800 dark:text-slate-100 flex items-center gap-1"><i data-lucide="book-open" class="w-4 h-4"></i> ${stats.totalExams}</span>
                    </div>
                    <div class="flex items-center justify-between border-b pb-2">
                        <span class="text-sm font-medium text-slate-500 dark:text-slate-400">Overall Accuracy</span>
                        <span class="text-lg font-bold text-green-600 dark:text-green-400 flex items-center gap-1"><i data-lucide="target" class="w-4 h-4"></i> ${stats.overallAccuracy}%</span>
                    </div>
                    <div class="flex items-center justify-between border-b pb-2">
                        <span class="text-sm font-medium text-slate-500 dark:text-slate-400">Total Correct Answers</span>
                        <span class="text-lg font-bold text-slate-800 dark:text-slate-100">${stats.totalCorrect}</span>
                    </div>
                    <div class="flex items-center justify-between border-b pb-2">
                        <span class="text-sm font-medium text-slate-500 dark:text-slate-400">Total Wrong Answers</span>
                        <span class="text-lg font-bold text-slate-800 dark:text-slate-100">${stats.totalWrong}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-slate-500 dark:text-slate-400">Total MCQ Score</span>
                        <span class="text-lg font-bold text-slate-800 dark:text-slate-100">${stats.totalMCQScore} / ${stats.totalMCQPossible}</span>
                    </div>
                </div>
            `;
            statsDataContainer.innerHTML = statHtml;
            lucide.createIcons();
            statsModal.classList.remove('hidden');
        };

        const renderRankingDetails = (examName) => {
            if (!examName || exams.length === 0) {
                rankingDetailsContainer.classList.add('hidden');
                return;
            }

            // 1. Filter exams by the active examName
            const filteredExams = exams.filter(exam => exam.examName.toLowerCase() === examName.toLowerCase());
            
            // 2. Map and sort by finalObtained (Total Mark including GPA)
            const rankingData = filteredExams
                .map(exam => ({
                    userId: exam.userId,
                    userName: exam.userName,
                    finalObtained: parseFloat(exam.calculatedData?.finalObtained || 0),
                    mcqScore: parseFloat(exam.calculatedData?.mcqScore || 0),
                    totalPossible: parseFloat(exam.calculatedData?.totalPossible || 0),
                    correctAns: parseInt(exam.correctAns || 0),
                    wrongAns: parseInt(exam.wrongAns || 0),
                    accuracy: parseFloat(exam.calculatedData?.accuracy || 0),
                    isCurrentUser: exam.userId === userId
                }))
                // Sort descending by finalObtained mark
                .sort((a, b) => b.finalObtained - a.finalObtained);

            // 3. Render the table
            let tableRows = '';
            rankingData.forEach((record, index) => {
                const isMyRecord = record.isCurrentUser;
                const rowClass = isMyRecord 
                    ? 'bg-indigo-100 dark:bg-indigo-800/50 font-bold border-indigo-500' 
                    : 'hover:bg-slate-50 dark:hover:bg-slate-700/50';
                
                const rankText = index < 3 
                    ? `<i data-lucide="${index === 0 ? 'trophy' : index === 1 ? 'award' : 'medal'}" class="w-4 h-4 text-yellow-500 fill-yellow-500"></i> ${index + 1}` 
                    : index + 1;

                // FIX: Ensure own name is also wrapped with .ranking-name for clickability
                const nameDisplay = isMyRecord 
                    ? `<span class="ranking-name" data-user-id="${record.userId}">${record.userName} (You)</span>`
                    : `<span class="ranking-name" data-user-id="${record.userId}">${record.userName}</span>`;

                tableRows += `
                    <tr class="${rowClass} border-b border-slate-200 dark:border-slate-700">
                        <td class="px-3 py-3 text-center text-sm md:text-base">${rankText}</td>
                        <td class="px-3 py-3 text-sm">${nameDisplay}</td>
                        <td class="px-3 py-3 font-semibold text-right text-indigo-600 dark:text-indigo-400">${record.finalObtained.toFixed(2)}</td>
                        <td class="px-3 py-3 text-right text-sm text-slate-500 dark:text-slate-400">${record.mcqScore.toFixed(2)}</td>
                        <td class="px-3 py-3 text-right text-sm text-green-500">${record.correctAns}</td>
                        <td class="px-3 py-3 text-right text-sm text-red-500">${record.wrongAns}</td>
                        <td class="px-3 py-3 text-right text-sm text-blue-500">${record.accuracy}%</td>
                    </tr>
                `;
            });

            // 4. Update the container HTML
            rankingDetailsContainer.classList.remove('hidden');
            rankingDetailsContainer.innerHTML = `
                <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md overflow-hidden border border-slate-100 dark:border-slate-700">
                    <div class="bg-indigo-600 dark:bg-indigo-900 p-4 text-white flex items-center justify-between">
                        <h2 class="font-bold text-lg flex items-center gap-2">
                            <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                            Ranking Chart: ${examName}
                        </h2>
                        <span class="text-xs bg-indigo-500/50 px-2 py-1 rounded-full">${rankingData.length} Competitors}</span>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                            <thead>
                                <tr class="bg-slate-50 dark:bg-slate-700/50">
                                    <th class="px-3 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider w-1/12">Rank</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider w-2/12">User Name</th>
                                    <th class="px-3 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider w-2/12" title="Includes GPA/Added Mark">Total Mark (Rank)</th>
                                    <th class="px-3 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider w-2/12" title="Score from only Correct/Wrong answers">MCQ Score</th>
                                    <th class="px-3 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider w-1/12">Correct</th>
                                    <th class="px-3 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider w-1/12">Wrong</th>
                                    <th class="px-3 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider w-2/12">Accuracy</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100 dark:divide-slate-700/50">
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                    <div class="p-2 text-center text-xs text-slate-500 dark:text-slate-400 border-t border-slate-100 dark:border-slate-700">
                        Ranking is based on the Total Obtained Mark (MCQ Score + GPA/Added Mark).
                    </div>
                </div>
            `;
            lucide.createIcons();

            // Add event listeners for clickable names
            rankingDetailsContainer.querySelectorAll('.ranking-name').forEach(nameSpan => {
                // FIX: Allow clicking on self's name too for the modal
                if (userId) { // Check only if we have a valid userId
                    nameSpan.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const targetId = e.target.getAttribute('data-user-id');
                        showUserStatsModal(targetId);
                    });
                } else {
                    nameSpan.classList.remove('ranking-name'); // Remove hover/cursor if userId is missing
                }
            });
        };

        // --- Rendering Functions ---

        const renderDarkMode = () => {
            if (darkMode) {
                document.documentElement.classList.add('dark');
                darkModeIcon.setAttribute('data-lucide', 'sun');
            } else {
                document.documentElement.classList.remove('dark');
                darkModeIcon.setAttribute('data-lucide', 'moon');
            }
            lucide.createIcons(); // Update icons
        };
        
        const StatCard = (title, value, subValue, iconName, color, isDarkMode) => {
            const card = document.createElement('div');
            card.className = `p-4 rounded-xl shadow-sm border flex items-center gap-4 hover:shadow-md transition-shadow ${isDarkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'}`;
            card.innerHTML = `
                <div class="${color} text-white p-3 rounded-lg shadow-sm">
                    <i data-lucide="${iconName}" class="w-5 h-5"></i>
                </div>
                <div>
                    <p class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wide">${title}</p>
                    <div class="flex items-baseline gap-1">
                        <h3 class="text-xl md:text-2xl font-bold text-slate-800 dark:text-slate-100">${value}</h3>
                        ${subValue ? `<span class="text-xs text-slate-400">${subValue}</span>` : ''}
                    </div>
                </div>
            `;
            return card;
        };

        const renderSummaryCards = () => {
            // Filter only the current user's exams for personal stats
            const myExams = exams.filter(e => e.userId === userId);

            // --- Overall Statistics Calculation (Personal) ---
            const totalExams = myExams.length;
            
            const totalMCQScore = myExams.reduce((acc, curr) => acc + parseFloat(curr.calculatedData?.mcqScore || 0), 0);
            const totalMCQPossible = myExams.reduce((acc, curr) => acc + (parseInt(curr.totalQuestions || 0) * parseFloat(curr.markPerQuestion || 1)), 0);
            
            const totalCorrect = myExams.reduce((acc, curr) => acc + parseInt(curr.correctAns || 0), 0);
            const totalWrong = myExams.reduce((acc, curr) => acc + parseInt(curr.wrongAns || 0), 0);
            const totalSkipped = myExams.reduce((acc, curr) => acc + parseInt(curr.skippedAns || 0), 0);
            
            const totalAttempted = totalCorrect + totalWrong;
            const overallAccuracy = calculateAccuracy(totalCorrect, totalWrong);

            // --- Rendering ---
            summaryCardsContainer.innerHTML = '';
            
            // 1. Total Exams
            const card1 = StatCard("Total Exams (Your)", totalExams, null, "book-open", "bg-blue-500", darkMode);
            
            // 2. Overall Score (Only MCQ/Exam Score)
            const card2 = StatCard(
                "Total MCQ Score (Your)", 
                `${totalMCQScore.toFixed(0)}`, 
                `/ ${totalMCQPossible.toFixed(0)}`, 
                "trending-up", 
                "bg-emerald-500", 
                darkMode
            );
            
            // 3. Attempted Questions
            const card3 = StatCard(
                "Attempted Questions", 
                totalAttempted, 
                `Skipped: ${totalSkipped}`, 
                "award", 
                "bg-violet-500", 
                darkMode
            );
            
            // 4. Incorrect Answers
            const card4 = StatCard(
                "Incorrect Answers", 
                totalWrong, 
                `Accuracy: ${overallAccuracy}%`, 
                "pie-chart", 
                "bg-orange-500", 
                darkMode
            );

            summaryCardsContainer.appendChild(card1);
            summaryCardsContainer.appendChild(card2);
            summaryCardsContainer.appendChild(card3);
            summaryCardsContainer.appendChild(card4);

            lucide.createIcons();
        };
        
        // Keeps track of the currently selected card ID for styling
        let selectedCardId = null;

        const ExamHistoryCard = (exam) => {
            const data = exam.calculatedData || {};
            const totalQ = parseInt(exam.totalQuestions || 0);

            const isMyExam = exam.userId === userId;
            
            const card = document.createElement('div');
            card.className = `exam-card rounded-xl shadow-sm border p-5 hover:shadow-lg transition duration-200 relative cursor-pointer ${darkMode ? 'bg-slate-800 border-slate-700 text-slate-200' : 'bg-white border-slate-100 text-slate-800'} ${exam.id === selectedCardId ? 'selected-exam-card border-indigo-500' : ''}`;
            card.dataset.id = exam.id;
            card.dataset.examName = exam.examName; // For ranking
            
            // Delete Button Logic (Only visible to the user who created it)
            const deleteButtonHtml = isMyExam ? `
                <button class="delete-button text-slate-300 dark:text-slate-600 hover:text-red-500 transition" data-id="${exam.id}" title="Delete Record">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            ` : '';
            
            const userTag = isMyExam 
                ? `<span class="text-xs font-medium text-green-600 dark:text-green-400 bg-green-50 dark:bg-green-900/30 px-2 py-0.5 rounded">Your Record</span>`
                : `<span class="text-xs font-medium text-purple-600 dark:text-purple-400 bg-purple-50 dark:bg-purple-900/30 px-2 py-0.5 rounded">By: ${exam.userName}</span>`;

            card.innerHTML = `
                <div class="absolute top-4 right-4 flex items-center gap-2">
                    ${deleteButtonHtml}
                </div>

                <div class="flex flex-col md:flex-row gap-4 md:items-center justify-between border-b border-slate-100 dark:border-slate-700 pb-4 mb-4">
                    <div>
                        <div class="flex flex-wrap items-center gap-2 mb-1">
                            <span class="text-xs font-bold bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 px-2 py-0.5 rounded border border-slate-200 dark:border-slate-600">
                                ${exam.date}
                            </span>
                            ${userTag}
                            ${exam.standard ? `
                                <span class="text-xs font-medium text-indigo-600 dark:text-indigo-400 bg-indigo-50 dark:bg-indigo-900/30 px-2 py-0.5 rounded">
                                    ${exam.standard}
                                </span>
                            ` : ''}
                        </div>
                        <h3 class="text-lg font-bold">${exam.examName}</h3>
                        
                        <div class="mt-2 text-xs text-slate-500 dark:text-slate-400 space-y-1">
                            <div class="flex flex-wrap gap-x-2">
                                <span title="Total Questions">Q: ${exam.totalQuestions}</span> •
                                <span title="Mark Per Question">x${exam.markPerQuestion}</span> •
                                <span title="Negative Marking" class="text-red-400">Neg: -${data.negativeDeduction}</span> 
                                ${parseFloat(exam.gpaMark) > 0 ? `<span title="GPA/Added Mark" class="text-green-500 font-bold">+GPA: ${exam.gpaMark}</span>` : ''}
                            </div>
                            ${exam.optionalSubject && exam.optionalSubject.trim() !== '' ? `
                                <div class="text-xs text-indigo-500 dark:text-indigo-300 font-medium pt-1 border-t border-slate-100 dark:border-slate-700/50 mt-1">
                                    Subjects Attempted: <span class="text-slate-700 dark:text-slate-300 font-normal">${exam.optionalSubject}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <div class="flex items-center gap-4">
                        <div class="text-right">
                            <p class="text-xs text-slate-500 dark:text-slate-400 uppercase font-semibold">Grade</p>
                            <p class="text-xl font-bold ${data.gradeInfo?.grade === 'F' ? 'text-red-500' : 'text-indigo-600 dark:text-indigo-400'}">
                                ${data.gradeInfo?.point} <span class="text-sm font-normal text-slate-400">(${data.gradeInfo?.grade})</span>
                            </p>
                        </div>
                        <div class="h-8 w-px bg-slate-200 dark:bg-slate-700 hidden md:block"></div>
                        <div class="text-right">
                            <p class="text-xs text-slate-500 dark:text-slate-400 uppercase font-semibold" title="MCQ Score + GPA/Added Mark">Total Obtained Mark</p>
                            <p class="text-xl font-bold">
                                ${data.finalObtained} <span class="text-sm text-slate-400">/ ${data.totalPossible}</span>
                            </p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div class="flex items-center gap-2 text-slate-600 dark:text-slate-400">
                        <i data-lucide="check-circle" class="w-4 h-4 text-green-500"></i>
                        <span>Correct: <strong>${exam.correctAns || 0}</strong></span>
                    </div>
                    <div class="flex items-center gap-2 text-slate-600 dark:text-slate-400">
                        <i data-lucide="x-circle" class="w-4 h-4 text-red-500"></i>
                        <span>Wrong: <strong>${exam.wrongAns || 0}</strong></span>
                    </div>
                    <div class="flex items-center gap-2 text-slate-600 dark:text-slate-400">
                        <i data-lucide="minus-circle" class="w-4 h-4 text-gray-400"></i>
                        <span>Skipped: <strong>${exam.skippedAns || 0}</strong></span>
                    </div>
                    <div class="flex items-center gap-2 text-slate-600 dark:text-slate-400 md:justify-end">
                        <i data-lucide="trending-up" class="w-4 h-4 text-blue-500"></i>
                        <span>Accuracy: <strong>${data.accuracy}%</strong></span>
                    </div>
                </div>

                <div class="mt-4 h-1.5 w-full bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden flex">
                    <div class="bg-green-500 h-full" style="width: ${((exam.correctAns || 0) / totalQ) * 100}%"></div>
                    <div class="bg-red-400 h-full" style="width: ${((exam.wrongAns || 0) / totalQ) * 100}%"></div>
                </div>
            `;
            
            // FIX: Simpler and more reliable delete mechanism using confirm()
            if (isMyExam) {
                const deleteButton = card.querySelector('.delete-button');
                
                deleteButton.addEventListener('click', (e) => {
                    e.stopPropagation(); // Stop event propagation
                    if (!userId) { return; }
                    
                    if (confirm(`Are you sure you want to permanently delete the exam record: "${exam.examName}"? This action cannot be undone.`)) {
                        deleteExamFromFirestore(exam.id);
                    }
                });
            }

            card.addEventListener('click', () => {
                // Update selection state
                selectedCardId = exam.id;
                
                // Set active exam for ranking display
                activeExamName = exam.examName;
                
                // Re-render history to apply selection style
                renderHistory(); 
                
                // Render ranking for the clicked exam
                renderRankingDetails(activeExamName); 
            });

            return card;
        };

        const renderHistory = () => {
            historyContainer.innerHTML = ''; // Clear container
            
            // Filter exams based on the view toggle state and sort them
            const recordsToShow = isShowingAllExams 
                ? exams // All records
                : exams.filter(e => e.userId === userId); // Only current user's records

            const sortedRecords = recordsToShow.sort((a, b) => b.timestamp - a.timestamp);

            // Update UI elements for the current view state
            historyTitle.textContent = isShowingAllExams ? 'All Public Exam Records' : 'My Exam History';
            viewToggle.textContent = isShowingAllExams ? 'View My Records Only' : 'View All Public Records';

            if (sortedRecords.length === 0) {
                noDataMessage.classList.remove('hidden');
                historyContainer.appendChild(noDataMessage);
                recordCountElement.textContent = `0 Records ${isShowingAllExams ? '(Public)' : '(Your)'}`;
            } else {
                noDataMessage.classList.add('hidden');
                recordCountElement.textContent = `${sortedRecords.length} Records ${isShowingAllExams ? '(Public)' : '(Your)'}`;
                
                const historyGrid = document.createElement('div');
                historyGrid.className = 'grid gap-4';
                
                sortedRecords.forEach(exam => {
                    historyGrid.appendChild(ExamHistoryCard(exam));
                });
                historyContainer.appendChild(historyGrid);
            }
            lucide.createIcons(); // Render new icons
            renderSummaryCards(); // Update statistics
        };

        // **NEW FUNCTION**: Google Sign-in Logic
        const handleGoogleSignIn = async () => {
            if (!auth) {
                alert("Firebase Authentication not initialized.");
                return;
            }

            const provider = new GoogleAuthProvider();
            try {
                // Sign out anonymous user if logged in
                if (auth.currentUser && auth.currentUser.isAnonymous) {
                    await auth.signOut();
                }

                // Sign in with Google Popup
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                
                // Set user name from Google profile or email
                const newUserName = user.displayName || user.email.split('@')[0] || `User-${user.uid.substring(0, 6)}`;
                localStorage.setItem(USER_NAME_KEY, newUserName);
                
                console.log("Google Sign-in successful:", user.uid);

            } catch (error) {
                console.error("Google Sign-in Error:", error);
                
                let errorMessage = "Google Sign-in failed. Please check console for details.";
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = "Sign-in cancelled. The popup was closed.";
                } else if (error.code === 'auth/cancelled-popup-request') {
                    errorMessage = "Sign-in failed. Please allow popups for this site.";
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                     errorMessage = "Error: An account already exists with the same email using a different login method.";
                }

                alert(errorMessage);
            }
        };


        // --- Event Handlers ---

        const handleFormSubmit = async (e) => {
            e.preventDefault();
            
            if (!isAuthReady || !userId) {
                console.error("App not ready: Authentication failed or not complete.");
                saveButton.innerHTML = '<i data-lucide="alert-triangle" class="w-4.5 h-4.5"></i> Error: App Not Ready.';
                saveButton.classList.add('bg-red-500', 'hover:bg-red-600');
                lucide.createIcons();
                return;
            }

            // Parse inputs using the new function
            const correctValue = parseInputSum(examForm.correctAns.value);
            const wrongValue = parseInputSum(examForm.wrongAns.value);
            
            const formData = {
                date: examForm.date.value,
                examName: examForm.examName.value.trim(),
                standard: examForm.standard.value.trim(),
                optionalSubject: examForm.optionalSubject.value.trim(), 
                
                // Calculation Inputs (These are straight numbers)
                totalQuestions: examForm.totalQuestions.value,
                markPerQuestion: examForm.markPerQuestion.value,
                negativePerWrong: examForm.negativePerWrong.value,
                gpaMark: examForm.gpaMark.value,
                
                // Result Inputs (Calculated from + sum)
                correctAns: correctValue.toString(),
                wrongAns: wrongValue.toString(),
                skippedAns: formSkippedAns.value 
            };

            // Basic Validation
            if (!formData.examName || !formData.totalQuestions || !examForm.userName.value.trim()) {
                console.error("Validation Error: Please fill in Your Name, Exam Name and Total Questions.");
                return; 
            }
            
            // Recalculate based on parsed values
            const totalQ = parseInt(formData.totalQuestions) || 0;
            const markPerQ = parseFloat(formData.markPerQuestion) || 1;
            const negativeMark = parseFloat(formData.negativePerWrong) || 0;
            const extraGpaMark = parseFloat(formData.gpaMark) || 0;
            
            const correct = correctValue;
            const wrong = wrongValue;

            // Exam Scores
            const mcqScore = (correct * markPerQ) - (wrong * negativeMark);
            const finalObtained = Math.max(0, mcqScore + extraGpaMark); 
            const totalPossible = (totalQ * markPerQ) + extraGpaMark;
            
            // Percentage for Grade is based on the final total score (MCQ + GPA)
            const percentage = totalPossible > 0 ? (finalObtained / totalPossible) * 100 : 0;

            const newExam = {
                ...formData,
                calculatedData: {
                    mcqScore: mcqScore.toFixed(2),
                    finalObtained: finalObtained.toFixed(2),
                    totalPossible: totalPossible.toFixed(2), 
                    percentage: percentage.toFixed(1),
                    gradeInfo: calculateGrade(percentage),
                    accuracy: calculateAccuracy(correct, wrong),
                    negativeDeduction: (wrong * negativeMark).toFixed(2)
                },
                date: examForm.date.value, 
                timestamp: new Date().getTime()
            };
            
            // Set the current exam as the active one for ranking display
            activeExamName = newExam.examName;
            
            // Save to Firestore (this will trigger the real-time listener and update the UI)
            await saveExamToFirestore(newExam);

            // Reset Form fields (keep settings values)
            examForm.examName.value = '';
            examForm.standard.value = '';
            examForm.optionalSubject.value = ''; 
            examForm.correctAns.value = '0';
            examForm.wrongAns.value = '0';
            formSkippedAns.value = '0';
            // Also update the hidden values of the input fields after successful save
            updateSkippedAns(); 
        };

        const updateSkippedAns = () => {
            // Use the parsing function for real-time validation feedback too
            const total = parseInt(formTotalQuestions.value) || 0;
            const correct = parseInputSum(formCorrectAns.value);
            const wrong = parseInputSum(formWrongAns.value);
            
            const attempted = correct + wrong;
            const skipped = Math.max(0, total - attempted); 
            formSkippedAns.value = skipped.toString();
        };

        const setupEventListeners = () => {
            // Dark Mode Toggle (Loads from localStorage and saves back)
            darkModeToggle.addEventListener('click', () => {
                darkMode = !darkMode;
                localStorage.setItem(THEME_KEY, darkMode ? 'dark' : 'light');
                renderDarkMode();
                renderHistory(); // Rerender for card color update
                if (activeExamName) renderRankingDetails(activeExamName); // Re-render ranking
            });

            // Set Current Date
            document.getElementById('form-date').value = new Date().toISOString().substr(0, 10);
            currentDateDisplay.textContent = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            // Form Submit (now calls async function)
            examForm.addEventListener('submit', handleFormSubmit);

            // Auto-calculate Skipped Answers (Updated to use parseInputSum)
            formTotalQuestions.addEventListener('input', updateSkippedAns);
            formCorrectAns.addEventListener('input', updateSkippedAns);
            formWrongAns.addEventListener('input', updateSkippedAns);
            updateSkippedAns(); 

            // History View Toggle
            viewToggle.addEventListener('click', () => {
                isShowingAllExams = !isShowingAllExams;
                renderHistory();
                // If an exam is active, re-render the ranking to refresh context/icons
                if (activeExamName) {
                    renderRankingDetails(activeExamName);
                }
            });
            
            // **UPDATED LISTENER**: Google Sign-in functionality enabled
            googleSignInButton.addEventListener('click', handleGoogleSignIn);


            // Title Editing (Still uses localStorage)
            appTitleContainer.addEventListener('click', () => {
                const currentTitle = appTitleDisplay.textContent;
                
                appTitleContainer.classList.add('hidden');

                const inputWrapper = document.createElement('div');
                inputWrapper.className = 'flex items-center gap-2';
                inputWrapper.id = 'title-edit-wrapper';
                inputWrapper.innerHTML = `
                    <input type="text" value="${currentTitle}" id="app-title-input"
                        class="text-slate-900 px-2 py-1 rounded text-lg font-bold w-full md:w-64 outline-none"
                        autofocus
                    />
                    <button id="save-title-button" class="bg-green-500 p-1 rounded hover:bg-green-600">
                        <i data-lucide="check" class="w-4.5 h-4.5"></i>
                    </button>
                `;
                appTitleContainer.parentNode.insertBefore(inputWrapper, appTitleContainer);
                lucide.createIcons();

                const titleInput = document.getElementById('app-title-input');
                const saveButton = document.getElementById('save-title-button');

                const saveTitle = () => {
                    const newTitle = titleInput.value.trim() || 'SIAM Exam Summary Tracker';
                    appTitleDisplay.textContent = newTitle;
                    localStorage.setItem(APP_TITLE_KEY, newTitle);
                    
                    inputWrapper.remove();
                    appTitleContainer.classList.remove('hidden');
                };

                saveButton.addEventListener('click', saveTitle);
                titleInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveTitle();
                    }
                });
            });
        };

        // --- Auth & Initialization ---

        const generateRandomUserName = (uid) => {
            const shortUid = uid.substring(0, 6);
            return `User-${shortUid}`;
        };

        const initFirebase = async () => {
            if (Object.keys(firebaseConfig).length === 0) {
                 console.error("Firebase config not found.");
                 userInfoDisplay.innerHTML = '<i data-lucide="alert-triangle" class="w-3 h-3 text-red-400"></i> Error: Firebase Config Missing.';
                 lucide.createIcons();
                 return;
            }
            
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // 1. Sign In (Custom Token if available, else Anonymous)
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Current simplified method: Anonymous Sign-in
                    // This is only a fallback, as Google Sign-in is now available.
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Auth failed:", error);
                userInfoDisplay.innerHTML = '<i data-lucide="alert-triangle" class="w-3 h-3 text-red-400"></i> Auth Failed.';
                lucide.createIcons();
            }

            // 2. Auth State Listener
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    
                    // Load saved name, or use Google's name/email, or generate default name
                    let currentUserName = localStorage.getItem(USER_NAME_KEY);
                    if (user.displayName && !currentUserName) {
                         currentUserName = user.displayName;
                         localStorage.setItem(USER_NAME_KEY, currentUserName);
                    }
                    userName = currentUserName || generateRandomUserName(userId);
                    formUserName.value = userName; // Set name in the input box
                    
                    isAuthReady = true;
                    userInfoDisplay.innerHTML = `<i data-lucide="cloud" class="w-3 h-3"></i> Cloud Ready. User: ${userName}`;
                    lucide.createIcons();
                    
                    // 3. Start Realtime Data Listener
                    startRealtimeListener(); 
                } else {
                    userId = null;
                    userName = "Anonymous User";
                    isAuthReady = false;
                    userInfoDisplay.innerHTML = '<i data-lucide="alert-triangle" class="w-3 h-3 text-red-400"></i> Signed Out.';
                    lucide.createIcons();
                }
            });
        };


        window.onload = function () {
            // Load theme and title immediately
            const savedTheme = localStorage.getItem(THEME_KEY);
            darkMode = savedTheme === 'dark';
            const savedTitle = localStorage.getItem(APP_TITLE_KEY);
            if (savedTitle) { appTitleDisplay.textContent = savedTitle; }
            renderDarkMode(); 
            
            // Setup DOM event listeners (form, buttons, etc.)
            setupEventListeners(); 
            
            // Initialize Firebase and start data sync
            initFirebase();
        };

    </script>
</body>
</html>